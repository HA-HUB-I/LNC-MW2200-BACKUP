<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LNC MW2200A â€“ Modbus Dashboard</title>
  <style>
    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --border:    #2a2d3e;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --accent:    #38bdf8;
      --green:     #22c55e;
      --yellow:    #facc15;
      --red:       #ef4444;
      --orange:    #f97316;
      --radius:    10px;
      --gap:       1rem;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .75rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: .02em;
      color: var(--accent);
    }

    #conn-badge {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .25rem .75rem;
      border-radius: 99px;
      font-size: .75rem;
      font-weight: 600;
      background: #1e293b;
      border: 1px solid var(--border);
      transition: background .3s;
    }

    #conn-badge .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--muted);
    }

    #conn-badge.connected   { border-color: var(--green); }
    #conn-badge.connected .dot { background: var(--green); box-shadow: 0 0 6px var(--green); }
    #conn-badge.error       { border-color: var(--red); }
    #conn-badge.error .dot  { background: var(--red); }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--gap);
      padding: var(--gap) 1.5rem 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem 1.25rem;
    }

    .card h2 {
      font-size: .7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--muted);
      margin-bottom: .75rem;
    }

    /* â”€â”€ Status flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .flags {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
    }

    .flag {
      padding: .2rem .6rem;
      border-radius: 6px;
      font-size: .72rem;
      font-weight: 600;
      background: #1e293b;
      color: var(--muted);
      border: 1px solid var(--border);
      transition: all .2s;
    }

    .flag.active-green  { background: #14532d44; color: var(--green);  border-color: var(--green); }
    .flag.active-red    { background: #7f1d1d44; color: var(--red);    border-color: var(--red);   }
    .flag.active-yellow { background: #71390044; color: var(--yellow); border-color: var(--yellow);}
    .flag.active-orange { background: #7c2d1244; color: var(--orange); border-color: var(--orange);}

    /* â”€â”€ Axis positions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .axis-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      padding: .4rem 0;
      border-bottom: 1px solid var(--border);
    }
    .axis-row:last-child { border-bottom: none; }

    .axis-label {
      font-size: .9rem;
      font-weight: 700;
      color: var(--accent);
      width: 2rem;
    }

    .axis-value {
      font-size: 1.4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: -.02em;
    }

    .axis-unit { font-size: .75rem; color: var(--muted); }

    /* â”€â”€ Gauges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gauge-row {
      display: flex;
      flex-direction: column;
      gap: .5rem;
      margin-top: .25rem;
    }

    .gauge-label-row {
      display: flex;
      justify-content: space-between;
      font-size: .75rem;
      color: var(--muted);
    }

    .gauge-value { font-weight: 700; color: var(--text); }

    .gauge-bar {
      height: 6px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }

    .gauge-fill {
      height: 100%;
      border-radius: 99px;
      background: var(--accent);
      transition: width .4s;
    }

    /* â”€â”€ Lot card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lot-counter {
      display: flex;
      align-items: baseline;
      gap: .3rem;
      font-size: 2.5rem;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      color: var(--accent);
    }

    .lot-of { font-size: 1rem; color: var(--muted); }
    .lot-target { font-size: 2rem; color: var(--text); }

    .lot-progress-wrap { margin: .6rem 0; }

    .lot-id-row {
      display: flex;
      justify-content: space-between;
      font-size: .75rem;
      color: var(--muted);
      margin-top: .4rem;
    }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .5rem;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      padding: .55rem .5rem;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: .78rem;
      font-weight: 600;
      cursor: pointer;
      background: #1e293b;
      color: var(--text);
      transition: background .15s, border-color .15s, opacity .15s;
    }

    .btn:hover   { background: #263448; }
    .btn:active  { opacity: .7; }
    .btn.green   { border-color: var(--green);  color: var(--green); }
    .btn.red     { border-color: var(--red);    color: var(--red); }
    .btn.yellow  { border-color: var(--yellow); color: var(--yellow); }
    .btn.orange  { border-color: var(--orange); color: var(--orange); }
    .btn.full    { grid-column: span 2; }

    /* Lot target input row */
    .lot-set-row {
      display: flex;
      gap: .4rem;
      margin-top: .75rem;
    }

    .lot-set-row input {
      flex: 1;
      background: #0f1117;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: .4rem .6rem;
      font-size: .85rem;
    }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: .6rem 1.1rem;
      border-radius: 8px;
      font-size: .82rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .3s, transform .3s;
      pointer-events: none;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: none;
    }

    #toast.ok  { background: #14532d; border: 1px solid var(--green);  color: var(--green);  }
    #toast.err { background: #7f1d1d; border: 1px solid var(--red);    color: var(--red);    }

    /* â”€â”€ Alarm banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #alarm-banner {
      display: none;
      margin: .5rem 1.5rem 0;
      padding: .6rem 1rem;
      background: #7f1d1d44;
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
      font-size: .82rem;
      font-weight: 600;
    }

    /* â”€â”€ Last-update bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      padding: .5rem;
      font-size: .68rem;
      color: var(--muted);
    }

    #conn-error-bar {
      display: none;
      margin: .4rem 1.5rem 0;
      padding: .4rem .8rem;
      background: #7f1d1d44;
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
      font-size: .72rem;
      font-family: monospace;
      word-break: break-all;
    }

    /* â”€â”€ Diagnostics card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #error-detail {
      display: none;
      margin-top: .5rem;
      padding: .4rem .6rem;
      background: #7f1d1d44;
      border: 1px solid var(--red);
      border-radius: 6px;
      color: var(--red);
      font-size: .72rem;
      font-family: monospace;
      word-break: break-all;
    }

    .diag-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .72rem;
      margin-top: .5rem;
    }

    .diag-table th, .diag-table td {
      text-align: left;
      padding: .25rem .4rem;
      border-bottom: 1px solid var(--border);
    }

    .diag-table th {
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
    }

    .diag-table td:first-child {
      font-family: monospace;
      color: var(--accent);
      white-space: nowrap;
    }

    /* â”€â”€ Runtime card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .runtime-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .5rem 1rem;
    }

    .runtime-item label {
      display: block;
      font-size: .68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: .15rem;
    }

    .runtime-value {
      font-size: 1.25rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--accent);
      letter-spacing: -.01em;
    }

    .runtime-value.inactive { color: var(--muted); font-size: 1rem; }

    #scan-output {
      display: none;
      margin-top: .75rem;
      max-height: 260px;
      overflow-y: auto;
    }

    #scan-errors {
      margin-top: .4rem;
      font-size: .72rem;
      color: var(--red);
      font-family: monospace;
    }
  </style>
</head>
<body>

<header>
  <h1>âš™ LNC MW2200A &mdash; Modbus Dashboard</h1>
  <div id="conn-badge">
    <span class="dot"></span>
    <span id="conn-text">Connecting&hellip;</span>
    <span id="conn-host" style="color:var(--muted)"> {{ modbus_host }}:{{ modbus_port }}</span>
  </div>
</header>

<div id="alarm-banner"></div>
<div id="conn-error-bar"></div>

<main>

  <!-- Status flags -->
  <div class="card">
    <h2>Machine Status</h2>
    <div class="flags">
      <span class="flag" id="fl-estop">E-Stop</span>
      <span class="flag" id="fl-alarm">Alarm</span>
      <span class="flag" id="fl-cycle">Cycle Running</span>
      <span class="flag" id="fl-hold">Feed Hold</span>
      <span class="flag" id="fl-home">Homing</span>
      <span class="flag" id="fl-spindle">Spindle ON</span>
      <span class="flag" id="fl-pause">Paused</span>
      <span class="flag" id="fl-door">Door Open</span>
    </div>
    <div style="margin-top:.6rem">
      <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.35rem">Stoppers / Locators</div>
      <div class="flags">
        <span class="flag" id="fl-forward-pos" title="FORWARD POS â€“ front stopper">â†‘ Front Stopper</span>
        <span class="flag" id="fl-left-pos"    title="LEFT POS â€“ left stopper">â† Left Stopper</span>
      </div>
    </div>
    <div style="margin-top:.75rem; font-size:.72rem; color:var(--muted)">
      Program&nbsp;#<span id="val-program">â€”</span>
      &nbsp;|&nbsp;
      Alarm&nbsp;code&nbsp;<span id="val-alarm">â€”</span>
    </div>
  </div>

  <!-- Axis positions -->
  <div class="card">
    <h2>Axis Positions</h2>
    <div class="axis-row">
      <span class="axis-label">X</span>
      <span><span class="axis-value" id="val-x">0.000</span>&nbsp;<span class="axis-unit">mm</span></span>
    </div>
    <div class="axis-row">
      <span class="axis-label">Y</span>
      <span><span class="axis-value" id="val-y">0.000</span>&nbsp;<span class="axis-unit">mm</span></span>
    </div>
    <div class="axis-row">
      <span class="axis-label">Z</span>
      <span><span class="axis-value" id="val-z">0.000</span>&nbsp;<span class="axis-unit">mm</span></span>
    </div>
  </div>

  <!-- Spindle & Feed -->
  <div class="card">
    <h2>Spindle &amp; Feed</h2>
    <div class="gauge-row">
      <div class="gauge-label-row">
        <span>Spindle Speed</span>
        <span class="gauge-value"><span id="val-spindle">0</span> RPM</span>
      </div>
      <div class="gauge-bar"><div class="gauge-fill" id="bar-spindle" style="width:0%;background:var(--accent)"></div></div>

      <div class="gauge-label-row" style="margin-top:.5rem">
        <span>Feed Rate</span>
        <span class="gauge-value"><span id="val-feed">0</span> mm/min</span>
      </div>
      <div class="gauge-bar"><div class="gauge-fill" id="bar-feed" style="width:0%;background:var(--green)"></div></div>
    </div>
  </div>

  <!-- Runtime / cycle time -->
  <div class="card">
    <h2>Runtime &amp; Cycle Time</h2>
    <div class="runtime-grid">
      <div class="runtime-item">
        <label>Current Cycle</label>
        <span class="runtime-value inactive" id="val-cycle-cur">â€”</span>
      </div>
      <div class="runtime-item">
        <label>Session Machining</label>
        <span class="runtime-value" id="val-cycle-total">0:00:00</span>
      </div>
      <div class="runtime-item">
        <label>Controller Idle Time</label>
        <span class="runtime-value inactive" id="val-idle-time">â€”</span>
      </div>
      <div class="runtime-item">
        <label>Modbus Packets</label>
        <span class="runtime-value" id="val-pkt-counter">â€”</span>
      </div>
    </div>
  </div>

  <!-- Lot counter -->
  <div class="card">
    <h2>Lot / Production</h2>
    <div class="lot-counter">
      <span id="val-lot-count">0</span>
      <span class="lot-of">of</span>
      <span class="lot-target" id="val-lot-target">0</span>
    </div>
    <div class="lot-progress-wrap">
      <div class="gauge-bar" style="height:10px">
        <div class="gauge-fill" id="bar-lot" style="width:0%;background:var(--orange)"></div>
      </div>
    </div>
    <div class="lot-id-row">
      <span>Lot ID: <strong id="val-lot-id">â€”</strong></span>
      <span><span id="val-lot-pct">0</span>%</span>
    </div>
    <div class="lot-set-row">
      <input id="inp-lot-target" type="number" min="0" placeholder="Set targetâ€¦" />
      <button class="btn orange" onclick="setLotTarget()">Set</button>
      <button class="btn red"    onclick="sendCommand('lot_reset')">Reset</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="card" style="grid-column: span 2">
    <h2>Controls</h2>
    <div class="controls-grid">
      <button class="btn green"  onclick="sendCommand('cycle_start')">â–¶ Cycle Start</button>
      <button class="btn yellow" onclick="sendCommand('feed_hold')">â¸ Feed Hold</button>
      <button class="btn"        onclick="sendCommand('spindle_cw')">â†» Spindle CW</button>
      <button class="btn"        onclick="sendCommand('spindle_ccw')">â†º Spindle CCW</button>
      <button class="btn"        onclick="sendCommand('vacuum_pump')">ğŸ’§ Vacuum Pump 1</button>
      <button class="btn"        onclick="sendCommand('aspiration')">ğŸŒ€ Aspiration ON</button>
      <button class="btn"        onclick="sendCommand('reset')">â†º Reset / Clear Alarm</button>
      <button class="btn red full" onclick="confirmEstop()">ğŸ›‘ SOFTWARE E-STOP</button>
    </div>
    <div style="margin-top:.9rem">
      <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.4rem">Stoppers / Locators (R20104 write)</div>
      <div class="controls-grid">
        <button class="btn" onclick="sendStopper('forward_pos', true)">â†‘ Front Stopper ON</button>
        <button class="btn" onclick="sendStopper('forward_pos', false)">â†‘ Front Stopper OFF</button>
        <button class="btn" onclick="sendStopper('left_pos', true)">â† Left Stopper ON</button>
        <button class="btn" onclick="sendStopper('left_pos', false)">â† Left Stopper OFF</button>
      </div>
    </div>
  </div>

  <!-- Diagnostics -->
  <div class="card" style="grid-column: span 2">
    <h2>Diagnostics &amp; Register Map</h2>
    <p style="font-size:.72rem;color:var(--muted);margin-bottom:.5rem">
      Use the scan to read raw Modbus values and verify endpoint mapping.
      Authentication: <strong style="color:var(--text)">none</strong> â€“ Modbus TCP has no built-in auth.
      Enable Modbus TCP on the controller: <code>parameter 45010 = 1</code>.
    </p>
    <button class="btn" style="width:auto;padding:.4rem 1rem" onclick="runScan()">ğŸ” Scan Registers</button>
    <div id="scan-output">
      <table class="diag-table" id="scan-table">
        <thead><tr><th>Type</th><th>Address</th><th>Description</th><th>Raw Value</th><th>Hex</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="scan-errors"></div>
    </div>
    <table class="diag-table" style="margin-top:.75rem">
      <thead><tr><th>Reg (0-based)</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>0</td><td>Machine status word (bit flags)</td></tr>
        <tr><td>1â€“2</td><td>X position â€“ signed 32-bit lo/hi words (Ã—0.001 mm)</td></tr>
        <tr><td>3â€“4</td><td>Y position</td></tr>
        <tr><td>5â€“6</td><td>Z position</td></tr>
        <tr><td>7</td><td>Spindle speed (RPM)</td></tr>
        <tr><td>8</td><td>Feed rate (mm/min)</td></tr>
        <tr><td>9</td><td>Active alarm code</td></tr>
        <tr><td>10</td><td>Program number</td></tr>
        <tr><td>11</td><td>Lot count (parts produced)</td></tr>
        <tr><td>12</td><td>Lot target</td></tr>
        <tr><td>13</td><td>Lot ID</td></tr>
        <tr><td>5000</td><td>Connection status (OpenPortResultAddr)</td></tr>
        <tr><td>5001</td><td>Connection idle time â€“ seconds (IdleTimeAddr)</td></tr>
        <tr><td>5002</td><td>Total Modbus packets processed (CounterAddr)</td></tr>
        <tr><td>5003</td><td>Last error data (ErrDataAddr)</td></tr>
        <tr><td>5004</td><td>Last error register address (ErrAddrAddr)</td></tr>
        <tr><td>5005</td><td>Packets sent by server (PkgThisAddr)</td></tr>
        <tr><td>5006</td><td>Packets received from client (PkgOtherAddr)</td></tr>
        <tr><td>5007</td><td>Packets responded (PkgRspAddr)</td></tr>
        <tr><td>5008</td><td>Exception (error) packets (PkgExcptionAddr)</td></tr>
        <tr><td>20104+20105</td><td>Stopper command R20104 â€“ HMIâ†’PLC (lo/hi words, 32-bit). Bit 17=FORWARD POS, 18=LEFT POS</td></tr>
        <tr><td>20204+20205</td><td>Stopper status R20204 â€“ PLCâ†’HMI (lo/hi words, 32-bit). Same bit map</td></tr>
      </tbody>
    </table>
    <p style="margin-top:.5rem;font-size:.68rem;color:var(--muted)">
      Coils (0-based): 0=Cycle Start, 1=Feed Hold, 2=Reset, 3=Spindle CW, 4=Spindle CCW, 5=Vacuum Pump 1, 6=E-Stop, 7=Lot Reset, 8=Aspiration<br>
      Stoppers via <code>/api/stopper</code>: <code>{"stopper":"forward_pos","value":true}</code> or <code>{"stopper":"left_pos","value":false}</code>
    </p>
  </div>

</main>

<footer id="footer-ts">Last update: â€”</footer>
<div id="toast"></div>

<script>
  const MAX_SPINDLE = 24000;
  const MAX_FEED    = 15000;

  function fmtSeconds(s) {
    s = Math.max(0, Math.floor(s));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }

  function showToast(msg, ok = true) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + (ok ? 'ok' : 'err');
    clearTimeout(t._timer);
    t._timer = setTimeout(() => { t.className = ''; }, 3000);
  }

  function setFlag(id, active, cls) {
    const el = document.getElementById(id);
    el.className = 'flag' + (active ? ' active-' + cls : '');
  }

  function pct(val, max) {
    return Math.min(100, Math.max(0, (val / max) * 100)).toFixed(1);
  }

  async function fetchStatus() {
    try {
      const res = await fetch('/api/status');
      if (!res.ok) throw new Error(res.statusText);
      const d = await res.json();

      // Connection badge
      const badge = document.getElementById('conn-badge');
      const connText = document.getElementById('conn-text');
      const errBar = document.getElementById('conn-error-bar');
      if (d.connected) {
        badge.className = 'connected';
        connText.textContent = 'Connected';
        errBar.style.display = 'none';
      } else {
        badge.className = 'error';
        connText.textContent = 'Disconnected';
        if (d.last_error) {
          errBar.textContent = 'âš  ' + d.last_error;
          errBar.style.display = 'block';
        } else {
          errBar.style.display = 'none';
        }
      }

      // Status flags
      setFlag('fl-estop',   d.estop_active,    'red');
      setFlag('fl-alarm',   d.alarm_active,    'red');
      setFlag('fl-cycle',   d.cycle_running,   'green');
      setFlag('fl-hold',    d.feed_hold_active,'yellow');
      setFlag('fl-home',    d.homing,          'orange');
      setFlag('fl-spindle', d.spindle_running, 'green');
      setFlag('fl-pause',   d.program_paused,  'yellow');
      setFlag('fl-door',    d.door_open,       'orange');

      // Stopper / locator flags
      setFlag('fl-forward-pos', d.forward_pos, 'green');
      setFlag('fl-left-pos',    d.left_pos,    'green');

      // Alarm banner
      const banner = document.getElementById('alarm-banner');
      if (d.alarm_active && d.alarm_code) {
        banner.style.display = 'block';
        banner.textContent = `âš  ALARM active â€“ code ${d.alarm_code}`;
      } else {
        banner.style.display = 'none';
      }

      // Positions
      document.getElementById('val-x').textContent = d.x_pos.toFixed(3);
      document.getElementById('val-y').textContent = d.y_pos.toFixed(3);
      document.getElementById('val-z').textContent = d.z_pos.toFixed(3);

      // Spindle / feed
      document.getElementById('val-spindle').textContent = d.spindle_rpm;
      document.getElementById('bar-spindle').style.width  = pct(d.spindle_rpm, MAX_SPINDLE) + '%';
      document.getElementById('val-feed').textContent = d.feed_rate;
      document.getElementById('bar-feed').style.width  = pct(d.feed_rate, MAX_FEED) + '%';

      // Program / alarm code
      document.getElementById('val-program').textContent = d.program_number || 'â€”';
      document.getElementById('val-alarm').textContent   = d.alarm_code     || 'â€”';

      // Lot
      document.getElementById('val-lot-count').textContent  = d.lot_count;
      document.getElementById('val-lot-target').textContent = d.lot_target;
      document.getElementById('val-lot-id').textContent     = d.lot_id || 'â€”';
      document.getElementById('val-lot-pct').textContent    = d.lot_progress_pct;
      document.getElementById('bar-lot').style.width = d.lot_progress_pct + '%';

      // Runtime / cycle time
      const cycCur = document.getElementById('val-cycle-cur');
      if (d.cycle_running && d.current_cycle_time_s > 0) {
        cycCur.textContent = fmtSeconds(d.current_cycle_time_s);
        cycCur.className = 'runtime-value';
      } else {
        cycCur.textContent = 'â€”';
        cycCur.className = 'runtime-value inactive';
      }
      document.getElementById('val-cycle-total').textContent = fmtSeconds(d.total_cycle_time_s);
      const idleEl = document.getElementById('val-idle-time');
      if (d.idle_time_s > 0) {
        idleEl.textContent = fmtSeconds(d.idle_time_s);
        idleEl.className = 'runtime-value';
      } else {
        idleEl.textContent = 'â€”';
        idleEl.className = 'runtime-value inactive';
      }
      document.getElementById('val-pkt-counter').textContent = d.pkt_counter > 0 ? d.pkt_counter : 'â€”';

      // Footer timestamp
      const ts = d.last_update ? new Date(d.last_update * 1000).toLocaleTimeString() : 'â€”';
      document.getElementById('footer-ts').textContent = 'Last update: ' + ts;

    } catch (e) {
      const badge = document.getElementById('conn-badge');
      badge.className = 'error';
      document.getElementById('conn-text').textContent = 'Error';
    }
  }

  async function sendCommand(cmd, value = true) {
    try {
      const res = await fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: cmd, value })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`âœ“ ${cmd} sent`, true);
      } else {
        showToast(`âœ— ${data.description || res.statusText}`, false);
      }
    } catch (e) {
      showToast('âœ— Network error', false);
    }
  }

  async function sendStopper(stopper, value) {
    try {
      const res = await fetch('/api/stopper', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stopper, value })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`âœ“ ${stopper} â†’ ${value ? 'ON' : 'OFF'}`, true);
      } else {
        showToast(`âœ— ${data.description || res.statusText}`, false);
      }
    } catch (e) {
      showToast('âœ— Network error', false);
    }
  }

  async function setLotTarget() {
    const inp = document.getElementById('inp-lot-target');
    const val = parseInt(inp.value, 10);
    if (isNaN(val) || val < 0) { showToast('Enter a valid number', false); return; }
    try {
      const res = await fetch('/api/lot/set_target', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target: val })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`âœ“ Lot target set to ${val}`, true);
        inp.value = '';
      } else {
        showToast(`âœ— ${data.description || res.statusText}`, false);
      }
    } catch (e) {
      showToast('âœ— Network error', false);
    }
  }

  async function runScan() {
    const out = document.getElementById('scan-output');
    const tbody = document.querySelector('#scan-table tbody');
    const errDiv = document.getElementById('scan-errors');
    out.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">Scanningâ€¦</td></tr>';
    errDiv.textContent = '';
    try {
      const res = await fetch('/api/scan');
      const data = await res.json();
      tbody.innerHTML = '';
      for (const row of data.scans) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.type}</td><td>${row.address}</td><td>${row.description || ''}</td><td>${row.raw_value}</td><td>${row.hex || ''}</td>`;
        tbody.appendChild(tr);
      }
      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">No registers read</td></tr>';
      }
      if (data.errors && data.errors.length) {
        errDiv.textContent = 'Errors: ' + data.errors.join(' | ');
      }
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:var(--red)">Scan failed: ' + e.message + '</td></tr>';
    }
  }

  function confirmEstop() {
    if (confirm('Send SOFTWARE E-STOP to the machine?')) {
      sendCommand('estop', true);
    }
  }

  // Poll every 500 ms
  fetchStatus();
  setInterval(fetchStatus, 500);
</script>
</body>
</html>
